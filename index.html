<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Postes Hardt 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        body.login-mode { display: flex; align-items: center; justify-content: center; padding: 20px; }
        body.app-mode { display: block; padding: 20px; }
        #loginPage { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center; }
        #loginPage h2 { color: #764ba2; margin-bottom: 25px; font-size: 1.5em; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; font-size: 16px; outline: none; }
        .login-input:focus { border-color: #667eea; }
        .btn-login { width: 100%; background: #667eea; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin-top: 15px; transition: 0.3s; }
        .btn-login:hover { background: #5a6fd6; }
        #mainApp { display: none; max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; position: relative; }
        .header h1 { font-size: 1.5em; }
        .admin-gear { position: absolute; top: 15px; right: 20px; font-size: 1.5em; cursor: pointer; transition: 0.3s; }
        .admin-gear:hover { transform: rotate(90deg); }
        .sync-status { position: absolute; top: 15px; left: 20px; font-size: 0.8em; padding: 5px 10px; border-radius: 20px; background: rgba(255,255,255,0.2); }
        .sync-status.online { background: #28a745; }
        .sync-status.offline { background: #dc3545; }
        .breadcrumb { background: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .nav-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .nav-left a { color: #667eea; text-decoration: none; font-weight: bold; cursor: pointer; transition: 0.3s; padding: 8px 12px; border-radius: 5px; }
        .nav-left a:hover { background: #667eea; color: white; }
        .nav-left .btn-infractions { background: #e53e3e; color: white; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9em; transition: 0.3s; }
        .nav-left .btn-infractions:hover { background: #c53030; }
        .nav-left .btn-controleur { background: #3182ce; color: white; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9em; transition: 0.3s; }
        .nav-left .btn-controleur:hover { background: #2c5282; }
        .nav-right a { color: #dc3545; text-decoration: none; font-weight: bold; cursor: pointer; padding: 8px 12px; border-radius: 5px; transition: 0.3s; }
        .nav-right a:hover { background: #dc3545; color: white; }
        .content { padding: 20px; }
        .hidden { display: none !important; }
        .months-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .month-card { background: white; border: 3px solid #e9ecef; border-radius: 10px; padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.3s; }
        .month-card:hover { border-color: #667eea; transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .month-card.disabled { opacity: 0.4; cursor: not-allowed; }
        .month-card.disabled:hover { transform: none; border-color: #e9ecef; }
        .month-name { font-size: 1.3em; font-weight: bold; color: #667eea; }
        .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .day-card { background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; min-height: 90px; display: flex; flex-direction: column; justify-content: center; }
        .day-card:hover { border-color: #667eea; transform: translateY(-3px); }
        .day-number { font-size: 1em; font-weight: bold; color: #667eea; text-transform: capitalize; }
        .closed-morning { color: #dc3545; font-size: 0.8em; margin-top: 8px; font-weight: bold; }
        .postes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .poste-box { background: #f8f9fa; border: 3px solid #dee2e6; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; position: relative; transition: 0.3s; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .poste-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .poste-box.libre { border-color: #28a745; background: #e8f5e9; }
        .poste-box.reserve { border-color: #ffc107; background: #fff9e6; }
        .poste-box.controle { border-color: #17a2b8; background: #e7f6f8; }
        .poste-box.controleur { border-color: #ffd700; border-width: 4px; background: #fffbf0; }
        .poste-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .poste-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .poste-heure { color: #17a2b8; font-size: 0.85em; font-weight: bold; }
        .poste-nom { font-weight: bold; margin-top: 8px; }
        .badge-peche { color: #28a745; font-size: 0.75em; font-weight: bold; margin-top: 5px; border: 1.5px solid #28a745; padding: 3px 6px; border-radius: 5px; background: white; }
        .btn-info { background: #17a2b8; color: white; padding: 5px 10px; font-size: 0.8em; margin-top: 8px; border-radius: 4px; border: none; cursor: pointer; transition: 0.3s; }
        .btn-info:hover { background: #138496; }
        .control-zone { width: 100%; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .control-zone input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        .control-zone .control-label { font-size: 0.85em; color: #666; cursor: pointer; }
        .control-zone .control-label.checked { color: #17a2b8; font-weight: bold; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 10px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.9em; }
        .modal, .alert-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; padding: 20px; }
        .modal-content, .alert-content { background: white; margin: 20px auto; border-radius: 15px; width: 100%; max-width: 500px; overflow: hidden; animation: slideDown 0.3s; }
        .modal-content.large { max-width: 700px; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .modal-body { padding: 20px; }
        .modal-body label { font-weight: bold; color: #333; display: block; margin-top: 12px; margin-bottom: 5px; }
        input[type="text"], input[type="password"], select { width: 100%; padding: 12px; margin: 5px 0 10px 0; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; outline: none; transition: 0.3s; }
        input[type="text"]:focus, input[type="password"]:focus, select:focus { border-color: #667eea; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; flex: 1; font-size: 1em; }
        .btn:hover { opacity: 0.9; }
        .btn-save { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-unban { background: #17a2b8; color: white; }
        .btn-back { background: #6c757d; color: white; margin-bottom: 15px; display: inline-block; padding: 10px 20px; text-decoration: none; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; font-size: 0.95em; }
        .btn-calendar { background: #9b59b6; color: white; }
        .infraction-item { padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid; }
        .infraction-item.avertissement { border-left-color: #ffc107; }
        .infraction-item.banni { border-left-color: #dc3545; }
        .infraction-item.archive { border-left-color: #6c757d; background: #e9ecef; }
        .infraction-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px; }
        .infraction-info { flex: 1; }
        .infraction-actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .infraction-actions .btn { padding: 8px 12px; font-size: 0.85em; flex: 0; }
        .archive-badge { background: #6c757d; color: white; font-size: 0.75em; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .controleur-badge { background: #3182ce; color: white; font-size: 0.75em; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .motifs-list { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-top: 10px; }
        .motifs-list h4 { margin-bottom: 8px; color: #856404; font-size: 0.9em; }
        .motif-item { padding: 5px 0; border-bottom: 1px solid #ffeeba; font-size: 0.85em; }
        .motif-item:last-child { border-bottom: none; }
        .info-motifs { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-top: 10px; text-align: left; }
        .info-motifs h4 { margin-bottom: 8px; color: #856404; }
        .info-motif-item { padding: 5px 0; border-bottom: 1px solid #ffeeba; font-size: 0.9em; }
        .info-motif-item:last-child { border-bottom: none; }
        
        /* Styles pour le module calendrier */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .calendar-header { background: #667eea; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 0.8em; border-radius: 5px; }
        .calendar-day { padding: 10px 5px; text-align: center; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; min-height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .calendar-day:hover { border-color: #667eea; }
        .calendar-day.empty { background: #f8f9fa; cursor: default; border: none; }
        .calendar-day.selected { background: #28a745; color: white; border-color: #28a745; }
        .calendar-day.morning-closed { background: #fff3cd; border-color: #ffc107; }
        .calendar-day.morning-closed.selected { background: linear-gradient(135deg, #28a745 50%, #ffc107 50%); }
        .calendar-day .morning-icon { font-size: 0.7em; margin-top: 2px; }
        .months-checkbox-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .month-checkbox-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .month-checkbox-item:hover { background: #e9ecef; }
        .month-checkbox-item input { width: 20px; height: 20px; cursor: pointer; }
        .month-checkbox-item.active { background: #d4edda; border: 2px solid #28a745; }
        .year-selector { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .year-selector button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1.2em; font-weight: bold; }
        .year-selector button:hover { background: #5a6fd6; }
        .year-selector span { font-size: 2em; font-weight: bold; color: #667eea; }
        .calendar-legend { display: flex; gap: 20px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.85em; }
        .legend-box { width: 20px; height: 20px; border-radius: 4px; border: 2px solid; }
        .legend-box.open { background: #28a745; border-color: #28a745; }
        .legend-box.closed { background: #f8f9fa; border-color: #e9ecef; }
        .legend-box.morning { background: #fff3cd; border-color: #ffc107; }
        .admin-section { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .admin-section h3 { color: #667eea; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 768px) { body.app-mode { padding: 10px; } .header { padding: 20px 15px; } .header h1 { font-size: 1.2em; } .content { padding: 15px; } .months-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; } .postes-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; } .calendar-grid { gap: 3px; } .calendar-day { padding: 8px 3px; font-size: 0.9em; min-height: 40px; } .months-checkbox-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { body.app-mode { padding: 5px; } #loginPage { padding: 25px 20px; margin: 10px; } .header { padding: 15px 10px; } .header h1 { font-size: 1em; padding: 0 30px; } .breadcrumb { padding: 8px 10px; flex-direction: column; } .months-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; } .postes-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; } .modal-content { margin: 5px; } .calendar-day { padding: 6px 2px; font-size: 0.8em; } }
    </style>
</head>
<body class="login-mode">
    <div id="loginPage">
        <h2>üëÆ Connexion<br>R√©servations / Contr√¥les Hardt</h2>
        <input type="text" id="loginID" class="login-input" value="HARDT" readonly tabindex="-1">
        <input type="password" id="loginPass" class="login-input" placeholder="Mot de passe" autofocus>
        <button class="btn-login" onclick="checkLogin()">Se connecter</button>
        <p id="errorLogin" style="color:red; margin-top:15px; font-weight:bold; display:none;">Mot de passe incorrect !</p>
        <p id="firebaseStatus" style="margin-top:15px; font-size:0.85em; color:#666;"></p>
    </div>
    <div id="mainApp">
        <div class="header">
            <span class="sync-status" id="syncStatus">üîÑ Connexion...</span>
            <span class="admin-gear" onclick="openAdmin()">‚öôÔ∏è</span>
            <h1 id="mainTitle">üìã R√©servation Postes Hardt 2026</h1>
        </div>
        <div class="breadcrumb">
            <div class="nav-left">
                <a onclick="showMonths()">üè† Accueil</a>
                <button class="btn-infractions" onclick="showInfractionsMenu()">‚ö†Ô∏è Infractions</button>
                <button class="btn-controleur" onclick="accesControleur()">üëÆ Contr√¥leur</button>
            </div>
            <div class="nav-right"><a onclick="logout()">D√©connexion üîí</a></div>
        </div>
        <div id="monthsPage" class="content"><div class="months-grid" id="monthsGrid"></div></div>
        <div id="infractionsMenuPage" class="content hidden">
            <button class="btn-back" onclick="showMonths()">‚Üê Retour Accueil</button>
            <div class="months-grid">
                <div class="month-card" onclick="showInfractionList('avertissements')" style="border-color: #ffc107;"><div style="font-size: 2.5em;">‚ö†Ô∏è</div><div class="month-name">AVERTISSEMENTS</div><p id="countAvertissement" style="font-weight: bold; margin-top:10px;">0 dossier(s)</p></div>
                <div class="month-card" onclick="showInfractionList('bannis')" style="border-color: #dc3545;"><div style="font-size: 2.5em;">üö´</div><div class="month-name">EXCLUSIONS</div><p id="countBanni" style="font-weight: bold; margin-top:10px;">0 dossier(s)</p></div>
            </div>
        </div>
        <div id="infractionsDetailPage" class="content hidden">
            <button class="btn-back" onclick="showInfractionsMenu()">‚Üê Retour</button>
            <h2 id="detailTitle" style="text-align: center; margin-bottom: 20px; color: #667eea;"></h2>
            <div id="detailList"></div>
        </div>
        <div id="daysPage" class="content hidden">
            <button class="btn-back" onclick="showMonths()">‚Üê Retour</button>
            <h2 id="monthTitle" style="text-align: center; margin-bottom: 20px; color: #667eea;"></h2>
            <div class="days-grid" id="daysGrid"></div>
        </div>
        <div id="postesPage" class="content hidden">
            <button class="btn-back" onclick="backToDays()">‚Üê Retour</button>
            <h2 id="postePageTitle" style="text-align: center; color: #667eea; margin-bottom: 15px; text-transform: capitalize; font-size: 1.4em;"></h2>
            <div class="stats-bar">
                <div class="stat-box"><div class="stat-number" id="statLibre">11</div><div class="stat-label">Libres</div></div>
                <div class="stat-box"><div class="stat-number" id="statReserve">0</div><div class="stat-label">R√©serv√©s</div></div>
                <div class="stat-box"><div class="stat-number" id="statControle">0</div><div class="stat-label">Contr√¥l√©s</div></div>
            </div>
            <div id="postesGrid" class="postes-grid"></div>
        </div>
    </div>
    
    <!-- Modal Poste -->
    <div id="posteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle">Poste</h2><p id="modalDate"></p></div>
            <div class="modal-body">
                <label>Nom</label><input type="text" id="modalNom" oninput="checkCardBadge()" placeholder="Entrez le nom">
                <label>Pr√©nom</label><input type="text" id="modalPrenom" oninput="checkCardBadge()" placeholder="Entrez le pr√©nom">
                <div id="modalBadgeZone" style="display:none; margin: 10px 0;"><span class="badge-peche">ü™™ Carte de p√™che valide</span></div>
                <div id="checkZone" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="modalControle" onchange="updateControlText()" style="width:22px; height:22px; cursor: pointer;">
                        <span id="controlStatusText" style="font-weight: bold;">Cliquer pour valider le contr√¥le</span>
                    </div>
                    <input type="hidden" id="modalHeure">
                </div>
                <div id="infractionsButtons" style="display:none; border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <p style="font-weight:bold; margin-bottom:10px;">‚ö†Ô∏è Actions Sanctions :</p>
                    <p style="font-size:0.85em; color:#666; margin-bottom:10px;">üìú R√®glement : 1√®re infraction = avertissement, 2√®me = exclusion</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="donnerAvertissement()" style="background: #ffc107; color: #333;">‚ö†Ô∏è Avertir</button>
                        <button class="btn" onclick="ouvrirChoixExclusion()" style="background: #dc3545; color: white;">üö´ Exclure</button>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px; flex-wrap: wrap;">
                    <button class="btn btn-save" onclick="saveModal()">üíæ Sauvegarder</button>
                    <button class="btn btn-delete" onclick="deleteModal()">üóëÔ∏è Effacer</button>
                    <button class="btn" onclick="closeModal()" style="background:#eee; color:#333;">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Admin -->
    <div id="adminModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header"><h2>‚öôÔ∏è Administration</h2></div>
            <div class="modal-body">
                <!-- Section Calendrier -->
                <div class="admin-section">
                    <h3>üìÖ Gestion du Calendrier</h3>
                    <p style="color:#666; font-size:0.9em; margin-bottom:15px;">Configurer l'ann√©e, les mois actifs et les jours d'ouverture</p>
                    <button class="btn btn-calendar" onclick="openCalendarManager()" style="width:100%;">üìÖ Ouvrir le Gestionnaire de Calendrier</button>
                </div>
                
                <!-- Section Google Sheet -->
                <div class="admin-section">
                    <h3>üîÑ Synchronisation Google Sheet</h3>
                    <button class="btn" onclick="syncFromGoogleSheets()" style="width:100%; background: #3182ce; color: white; margin-bottom: 10px;">üîÑ Synchroniser depuis Google Sheet</button>
                    <button class="btn" onclick="exportToGoogleSheets()" style="width:100%; background: #28a745; color: white;">üì§ Exporter vers Google Sheet</button>
                </div>
                
                <!-- Section P√™cheurs Valides -->
                <div class="admin-section">
                    <h3>ü™™ Liste P√™cheurs Valides</h3>
                    <label>NOM</label><input type="text" id="adminAddNom" placeholder="NOM">
                    <label>Pr√©nom</label><input type="text" id="adminAddPrenom" placeholder="Pr√©nom">
                    <button class="btn btn-save" style="width:100%; margin: 15px 0;" onclick="addValidUser()">‚ûï Ajouter √† la liste</button>
                    <div id="adminValidList" style="max-height:150px; overflow-y:auto; border-top:1px solid #eee; padding-top:10px;"></div>
                </div>
                
                <button class="btn" style="width:100%; background:#eee; color:#333; margin-top:15px;" onclick="closeAdmin()">Fermer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Gestionnaire Calendrier -->
    <div id="calendarModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);"><h2>üìÖ Gestionnaire de Calendrier</h2></div>
            <div class="modal-body">
                <!-- S√©lecteur d'ann√©e -->
                <div class="year-selector">
                    <button onclick="changeYear(-1)">‚óÄ</button>
                    <span id="calendarYear">2026</span>
                    <button onclick="changeYear(1)">‚ñ∂</button>
                </div>
                
                <!-- Mois actifs -->
                <h3 style="margin-bottom:10px; color:#667eea;">üìÜ Mois actifs</h3>
                <div class="months-checkbox-grid" id="monthsCheckboxGrid"></div>
                
                <!-- Bouton configurer jours -->
                <h3 style="margin: 20px 0 10px; color:#667eea;">üìã Configurer les jours d'ouverture</h3>
                <select id="selectMonthConfig" style="margin-bottom:15px;" onchange="loadMonthCalendar()">
                    <option value="">-- S√©lectionner un mois --</option>
                </select>
                
                <!-- Calendrier du mois -->
                <div id="monthCalendarZone" style="display:none;">
                    <div class="calendar-legend">
                        <div class="legend-item"><div class="legend-box closed"></div> Ferm√©</div>
                        <div class="legend-item"><div class="legend-box open"></div> Ouvert</div>
                        <div class="legend-item"><div class="legend-box morning"></div> Ferm√© le matin</div>
                    </div>
                    <p style="text-align:center; font-size:0.85em; color:#666; margin-bottom:10px;">
                        <strong>Clic simple</strong> = Ouvrir/Fermer | <strong>Double-clic</strong> = Ferm√© le matin
                    </p>
                    <div class="calendar-grid" id="monthCalendarGrid"></div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:25px;">
                    <button class="btn btn-save" onclick="saveCalendarConfig()">üíæ Enregistrer</button>
                    <button class="btn" onclick="closeCalendarManager()" style="background:#eee; color:#333;">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Avertissement -->
    <div id="motifModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="motifHeader" style="background:#ffc107;"><h2>‚ö†Ô∏è Avertissement</h2></div>
            <div class="modal-body">
                <label>üëÆ Contr√¥leur ayant constat√© l'infraction :</label>
                <select id="motifControleur" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:8px;margin-bottom:15px;">
                    <option value="">-- Choisir le contr√¥leur --</option>
                </select>
                <label>Motif de l'avertissement :</label>
                <input type="text" id="motifInput" placeholder="Ex: Absence de carte de p√™che...">
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-save" onclick="confirmerAvertissement()">‚úÖ Confirmer l'avertissement</button>
                    <button class="btn" onclick="closeMotif()" style="background:#eee; color:#333;">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Exclusion -->
    <div id="exclusionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background:#dc3545;"><h2>üö´ Exclusion</h2></div>
            <div class="modal-body">
                <div id="exclusionInfo" style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #ffc107;"></div>
                <div id="exclusionControleurGroup">
                    <label>üëÆ Contr√¥leur ayant constat√© l'infraction :</label>
                    <select id="exclusionControleur" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:8px;margin-bottom:15px;">
                        <option value="">-- Choisir le contr√¥leur --</option>
                    </select>
                </div>
                <div id="exclusionMotifGroup">
                    <label>Motif de l'exclusion :</label>
                    <input type="text" id="exclusionMotif" placeholder="Ex: Non respect du r√®glement...">
                </div>
                <label style="margin-top:15px;">Type d'exclusion :</label>
                <div style="display:flex; gap:15px; margin:15px 0;">
                    <label style="display:flex; align-items:center; gap:8px; padding:15px; background:#f8f9fa; border-radius:8px; cursor:pointer; flex:1; border:2px solid #ddd;" onclick="this.querySelector('input').checked=true; document.querySelectorAll('#exclusionModal label[style*=flex]').forEach(l=>l.style.borderColor='#ddd'); this.style.borderColor='#dc3545';">
                        <input type="radio" name="typeExclusion" value="temporaire" style="width:20px;height:20px;">
                        <span><strong>‚è±Ô∏è Temporaire</strong><br><small>1 mois</small></span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; padding:15px; background:#f8f9fa; border-radius:8px; cursor:pointer; flex:1; border:2px solid #ddd;" onclick="this.querySelector('input').checked=true; document.querySelectorAll('#exclusionModal label[style*=flex]').forEach(l=>l.style.borderColor='#ddd'); this.style.borderColor='#dc3545';">
                        <input type="radio" name="typeExclusion" value="definitive" style="width:20px;height:20px;">
                        <span><strong>üö´ D√©finitive</strong><br><small>Sans limite</small></span>
                    </label>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" onclick="confirmerExclusion()" style="background:#dc3545; color:white; flex:1;">üö´ Confirmer l'exclusion</button>
                    <button class="btn" onclick="closeExclusion()" style="background:#eee; color:#333;">Annuler</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Alerte -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-content">
            <div id="alertHeader" style="background:#667eea; color:white; padding:15px; text-align:center;"><h3>INFO</h3></div>
            <div id="alertBody" class="alert-body" style="padding:20px;"></div>
            <div style="text-align:center; padding-bottom:20px;"><button class="btn btn-save" onclick="closeAlert()">OK</button></div>
        </div>
    </div>
    
    <!-- Modal Contr√¥leur -->
    <div id="controleurModal" class="modal">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-header" style="background:#1565c0;"><h2>üëÆ Contr√¥le</h2></div>
            <div class="modal-body">
                <p style="margin-bottom:15px;font-weight:bold;">S√©lectionnez le contr√¥leur :</p>
                <select id="selectControleur" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:8px;margin-bottom:20px;"><option value="">-- Choisir --</option></select>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-save" onclick="confirmControleur()">‚úÖ Valider</button>
                    <button class="btn" onclick="closeControleurModal()" style="background:#eee;color:#333;">Annuler</button>
                </div>
                <div style="margin-top:15px;border-top:1px solid #ddd;padding-top:15px;">
                    <button class="btn" onclick="annulerControle()" style="background:#dc3545;color:white;width:100%;">‚ùå Annuler le contr√¥le</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        (function() { const urlParams = new URLSearchParams(window.location.search); const autoconnect = urlParams.get('autoconnect'); const fromControleur = urlParams.get('from') === 'controleur'; if (autoconnect === '911') { document.addEventListener('DOMContentLoaded', function() { document.getElementById('loginPass').value = '911'; setTimeout(function() { checkLogin(); }, 500); if (fromControleur) { const btn = document.createElement('button'); btn.innerHTML = '‚Üê Retour Contr√¥leur'; btn.style.cssText = 'position:fixed;top:15px;left:15px;z-index:9999;background:linear-gradient(135deg,#1a472a,#2d5a3d);color:#fff;border:none;padding:12px 20px;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3);'; btn.onclick = function() { window.close(); }; document.body.appendChild(btn); } }); } })();
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDbuJDOKo7XoycUeOF59V9aW3IDztg6Gx-nlrUnmrHpaPOD3v9x9ek481EL6egzuE/exec";
        function sendToGoogleSheets(data) { fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(() => console.log("‚úÖ Envoy√© GSheets")).catch(err => console.error("‚ùå Erreur:", err)); }
        function syncFromGoogleSheets() { if (!checkAdminPassword()) return; showAlert('Synchronisation...'); closeAlert(); }
        function exportToGoogleSheets() { if (!checkAdminPassword()) return; showAlert('Export...'); closeAlert(); }
        
        const firebaseConfig = { apiKey: "AIzaSyADXcfDOBLHC7pdlGedDW-4wAHKyPHW19I", authDomain: "resahardt.firebaseapp.com", databaseURL: "https://resahardt-default-rtdb.europe-west1.firebasedatabase.app", projectId: "resahardt", storageBucket: "resahardt.firebasestorage.app", messagingSenderId: "159584744908", appId: "1:159584744908:web:1cc909277052b56e945969" };
        
        // Base centrale pour les infractions (synchronisation avec appli contr√¥leurs)
        const firebaseConfigCentral = { databaseURL: "https://appli-controleur-gunder-default-rtdb.europe-west1.firebasedatabase.app" };
        
        let app, database, appCentral, dbCentral, firebaseReady = false;
        try { 
            app = firebase.initializeApp(firebaseConfig); 
            database = firebase.database(); 
            // Initialiser la base centrale pour les infractions
            appCentral = firebase.initializeApp(firebaseConfigCentral, 'central');
            dbCentral = firebase.database(appCentral);
            firebaseReady = true; 
        } catch (error) { console.error("‚ùå Firebase:", error); }
        
        // ===== CALENDRIER PAR D√âFAUT (2026) =====
        const DEFAULT_JOURS_OUVERTURE = { 1: [28], 2: [6, 7, 13, 14, 20, 21, 22, 27, 28], 3: [3, 4, 5, 10, 11, 17, 18, 24, 25], 4: [5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 5: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30], 6: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 7: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], 8: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30], 9: [2, 3, 9, 10, 16, 17, 23, 24, 30, 31], 10: [6, 7, 10, 13, 14, 20, 21, 27, 28], 11: [4, 5, 11, 12, 18, 19, 24, 25, 26] };
        const DEFAULT_FERME_MATIN = { 1: [28], 2: [28], 3: [25], 5: [13], 8: [19], 9: [17], 10: [14] };
        
        const MOIS_NOMS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        
        // ===== VARIABLES GLOBALES =====
        let reservations = {}, infractions = { avertissements: [], bannis: [] }, validUsers = [], controleurs = [];
        let calendrierConfig = { annee: 2026, joursOuverture: {}, fermeMatin: {} };
        let pendingControlePoste = null, curM, curMName, curDKey, curP, curFullDate, pendingSanctionType;
        let tempCalendarConfig = {}; // Config temporaire pendant l'√©dition
        
        // ===== FIREBASE LISTENERS =====
        function setupFirebaseListeners() { 
            if (!firebaseReady) return; 
            const connectedRef = database.ref(".info/connected"); 
            connectedRef.on("value", (snap) => { 
                const statusEl = document.getElementById('syncStatus'); 
                statusEl.textContent = snap.val() ? "üü¢ En ligne" : "üî¥ Hors ligne"; 
                statusEl.className = "sync-status " + (snap.val() ? "online" : "offline"); 
            }); 
            database.ref('reservations').on('value', (snapshot) => { reservations = snapshot.val() || {}; if (!document.getElementById('postesPage').classList.contains('hidden')) renderPostes(); }); 
            // INFRACTIONS: Lecture depuis la base CENTRALE (synchronis√©e avec appli contr√¥leurs)
            dbCentral.ref('infractions').on('value', (snapshot) => { infractions = snapshot.val() || { avertissements: [], bannis: [] }; if (!infractions.avertissements) infractions.avertissements = []; if (!infractions.bannis) infractions.bannis = []; updateCounts(); console.log('üì° Infractions synchronis√©es depuis base centrale'); }); 
            database.ref('validUsers').on('value', (snapshot) => { const data = snapshot.val(); validUsers = data ? Object.values(data) : []; if (!document.getElementById('postesPage').classList.contains('hidden')) renderPostes(); }); 
            // CONTROLEURS: Lecture depuis la base CENTRALE
            dbCentral.ref('controleurs').on('value', (snapshot) => { const data = snapshot.val(); controleurs = data ? (Array.isArray(data) ? data : Object.values(data)) : []; updateControleurSelect(); updateMotifControleurSelect(); updateExclusionControleurSelect(); });
            
            // √âcouter la config calendrier
            database.ref('calendrierConfig').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    calendrierConfig = data;
                } else {
                    // Premi√®re fois : migrer les donn√©es par d√©faut
                    calendrierConfig = {
                        annee: 2026,
                        joursOuverture: DEFAULT_JOURS_OUVERTURE,
                        fermeMatin: DEFAULT_FERME_MATIN
                    };
                    saveCalendrierConfig();
                }
                updateMainTitle();
                renderMonths();
            });
        }
        
        function saveReservations() { if (!firebaseReady) return; database.ref('reservations').set(reservations); }
        // INFRACTIONS: Sauvegarde dans la base CENTRALE (synchronis√©e avec appli contr√¥leurs)
        function saveInfractions() { if (!firebaseReady) return; dbCentral.ref('infractions').set(infractions); }
        function saveValidUsers() { if (!firebaseReady) return; const usersObj = {}; validUsers.forEach((u, i) => { usersObj['user_' + i] = u; }); database.ref('validUsers').set(usersObj); }
        function saveCalendrierConfig() { if (!firebaseReady) return; database.ref('calendrierConfig').set(calendrierConfig); }
        
        // ===== FONCTIONS CALENDRIER =====
        function getJoursOuverture() {
            return calendrierConfig.joursOuverture || DEFAULT_JOURS_OUVERTURE;
        }
        
        function getFermeMatin() {
            return calendrierConfig.fermeMatin || DEFAULT_FERME_MATIN;
        }
        
        function getAnnee() {
            return calendrierConfig.annee || 2026;
        }
        
        function updateMainTitle() {
            document.getElementById('mainTitle').textContent = `üìã R√©servation Postes Hardt ${getAnnee()}`;
        }
        
        function openCalendarManager() {
            closeAdmin();
            // Copier la config actuelle pour l'√©dition
            tempCalendarConfig = JSON.parse(JSON.stringify(calendrierConfig));
            document.getElementById('calendarYear').textContent = tempCalendarConfig.annee;
            renderMonthsCheckboxes();
            updateMonthSelect();
            document.getElementById('monthCalendarZone').style.display = 'none';
            document.getElementById('selectMonthConfig').value = '';
            document.getElementById('calendarModal').style.display = 'block';
        }
        
        function closeCalendarManager() {
            document.getElementById('calendarModal').style.display = 'none';
        }
        
        function changeYear(delta) {
            tempCalendarConfig.annee += delta;
            if (tempCalendarConfig.annee < 2024) tempCalendarConfig.annee = 2024;
            if (tempCalendarConfig.annee > 2050) tempCalendarConfig.annee = 2050;
            document.getElementById('calendarYear').textContent = tempCalendarConfig.annee;
        }
        
        function renderMonthsCheckboxes() {
            const container = document.getElementById('monthsCheckboxGrid');
            const joursOuverture = tempCalendarConfig.joursOuverture || {};
            
            container.innerHTML = MOIS_NOMS.map((nom, i) => {
                const moisNum = i + 1;
                const isActive = joursOuverture[moisNum] && joursOuverture[moisNum].length > 0;
                return `
                    <div class="month-checkbox-item ${isActive ? 'active' : ''}" onclick="toggleMonth(${moisNum})">
                        <input type="checkbox" ${isActive ? 'checked' : ''} onclick="event.stopPropagation(); toggleMonth(${moisNum})">
                        <span>${nom}</span>
                    </div>
                `;
            }).join('');
        }
        
        function toggleMonth(mois) {
            if (!tempCalendarConfig.joursOuverture) tempCalendarConfig.joursOuverture = {};
            
            if (tempCalendarConfig.joursOuverture[mois] && tempCalendarConfig.joursOuverture[mois].length > 0) {
                // D√©sactiver le mois
                tempCalendarConfig.joursOuverture[mois] = [];
                if (tempCalendarConfig.fermeMatin) tempCalendarConfig.fermeMatin[mois] = [];
            } else {
                // Activer le mois avec quelques jours par d√©faut (weekends)
                const jours = [];
                const annee = tempCalendarConfig.annee;
                const nbJours = new Date(annee, mois, 0).getDate();
                for (let j = 1; j <= nbJours; j++) {
                    const date = new Date(annee, mois - 1, j);
                    if (date.getDay() === 0 || date.getDay() === 6) { // Samedi ou Dimanche
                        jours.push(j);
                    }
                }
                tempCalendarConfig.joursOuverture[mois] = jours;
            }
            
            renderMonthsCheckboxes();
            updateMonthSelect();
        }
        
        function updateMonthSelect() {
            const select = document.getElementById('selectMonthConfig');
            const joursOuverture = tempCalendarConfig.joursOuverture || {};
            
            select.innerHTML = '<option value="">-- S√©lectionner un mois --</option>' +
                MOIS_NOMS.map((nom, i) => {
                    const moisNum = i + 1;
                    const isActive = joursOuverture[moisNum] && joursOuverture[moisNum].length > 0;
                    return `<option value="${moisNum}" ${!isActive ? 'disabled' : ''}>${nom} ${!isActive ? '(inactif)' : ''}</option>`;
                }).join('');
        }
        
        function loadMonthCalendar() {
            const mois = parseInt(document.getElementById('selectMonthConfig').value);
            if (!mois) {
                document.getElementById('monthCalendarZone').style.display = 'none';
                return;
            }
            
            document.getElementById('monthCalendarZone').style.display = 'block';
            renderMonthCalendar(mois);
        }
        
        function renderMonthCalendar(mois) {
            const grid = document.getElementById('monthCalendarGrid');
            const annee = tempCalendarConfig.annee;
            const joursOuverture = tempCalendarConfig.joursOuverture[mois] || [];
            const fermeMatin = (tempCalendarConfig.fermeMatin && tempCalendarConfig.fermeMatin[mois]) || [];
            
            // Ent√™tes jours
            const joursNoms = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let html = joursNoms.map(j => `<div class="calendar-header">${j}</div>`).join('');
            
            // Premier jour du mois
            const premierJour = new Date(annee, mois - 1, 1);
            let jourSemaine = premierJour.getDay();
            jourSemaine = jourSemaine === 0 ? 6 : jourSemaine - 1; // Lundi = 0
            
            // Cases vides avant le premier jour
            for (let i = 0; i < jourSemaine; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Jours du mois
            const nbJours = new Date(annee, mois, 0).getDate();
            for (let j = 1; j <= nbJours; j++) {
                const isOpen = joursOuverture.includes(j);
                const isMorningClosed = fermeMatin.includes(j);
                
                let classes = 'calendar-day';
                if (isOpen) classes += ' selected';
                if (isMorningClosed) classes += ' morning-closed';
                
                html += `
                    <div class="${classes}" onclick="toggleDay(${mois}, ${j})" ondblclick="toggleMorning(${mois}, ${j})">
                        ${j}
                        ${isMorningClosed ? '<span class="morning-icon">üåÖ</span>' : ''}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        function toggleDay(mois, jour) {
            if (!tempCalendarConfig.joursOuverture[mois]) tempCalendarConfig.joursOuverture[mois] = [];
            
            const index = tempCalendarConfig.joursOuverture[mois].indexOf(jour);
            if (index > -1) {
                // Fermer le jour
                tempCalendarConfig.joursOuverture[mois].splice(index, 1);
                // Retirer aussi de fermeMatin si pr√©sent
                if (tempCalendarConfig.fermeMatin && tempCalendarConfig.fermeMatin[mois]) {
                    const mIdx = tempCalendarConfig.fermeMatin[mois].indexOf(jour);
                    if (mIdx > -1) tempCalendarConfig.fermeMatin[mois].splice(mIdx, 1);
                }
            } else {
                // Ouvrir le jour
                tempCalendarConfig.joursOuverture[mois].push(jour);
                tempCalendarConfig.joursOuverture[mois].sort((a, b) => a - b);
            }
            
            renderMonthCalendar(mois);
            renderMonthsCheckboxes();
        }
        
        function toggleMorning(mois, jour) {
            // V√©rifier que le jour est ouvert
            if (!tempCalendarConfig.joursOuverture[mois] || !tempCalendarConfig.joursOuverture[mois].includes(jour)) {
                return; // Jour ferm√©, on ne peut pas mettre "ferm√© le matin"
            }
            
            if (!tempCalendarConfig.fermeMatin) tempCalendarConfig.fermeMatin = {};
            if (!tempCalendarConfig.fermeMatin[mois]) tempCalendarConfig.fermeMatin[mois] = [];
            
            const index = tempCalendarConfig.fermeMatin[mois].indexOf(jour);
            if (index > -1) {
                tempCalendarConfig.fermeMatin[mois].splice(index, 1);
            } else {
                tempCalendarConfig.fermeMatin[mois].push(jour);
                tempCalendarConfig.fermeMatin[mois].sort((a, b) => a - b);
            }
            
            renderMonthCalendar(mois);
        }
        
        function saveCalendarConfig() {
            calendrierConfig = JSON.parse(JSON.stringify(tempCalendarConfig));
            saveCalendrierConfig();
            closeCalendarManager();
            showAlert('‚úÖ Calendrier enregistr√© !');
            renderMonths();
            updateMainTitle();
        }
        
        // ===== AUTHENTIFICATION =====
        function checkLogin() { if (document.getElementById('loginPass').value === "911") { if (!firebaseReady) { showAlert("‚ö†Ô∏è Connexion Firebase..."); return; } document.getElementById('loginPage').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; document.body.className = 'app-mode'; sessionStorage.setItem('logged', 'true'); setupFirebaseListeners(); renderMonths(); updateCounts(); } else { document.getElementById('errorLogin').style.display = 'block'; setTimeout(() => { document.getElementById('errorLogin').style.display = 'none'; }, 3000); } }
        document.getElementById("loginPass").addEventListener("keyup", function(e) { if (e.key === "Enter") checkLogin(); });
        function logout() { sessionStorage.removeItem('logged'); location.reload(); }
        
        function accesControleur() { 
            const today = new Date(); 
            const jour = today.getDate(); 
            const mois = today.getMonth(); 
            const annee = today.getFullYear();
            const configAnnee = getAnnee();
            
            if (annee !== configAnnee) { 
                showAlert(`üìÖ Application configur√©e pour ${configAnnee}`); 
                return; 
            } 
            
            const joursOuverts = getJoursOuverture()[mois + 1] || []; 
            if (!joursOuverts.includes(jour)) { 
                showAlert("üö´ √âtang ferm√© aujourd'hui"); 
                return; 
            } 
            
            const key = `${annee}-${String(mois + 1).padStart(2, '0')}-${String(jour).padStart(2, '0')}`; 
            const dateFull = today.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }); 
            curM = mois; 
            curMName = MOIS_NOMS[mois]; 
            showPostes(jour, key, dateFull); 
        }
        
        function checkAdminPassword() { return prompt("üîê Mot de passe admin :") === "admin"; }
        function hideAll() { ['monthsPage', 'daysPage', 'postesPage', 'infractionsMenuPage', 'infractionsDetailPage'].forEach(id => { document.getElementById(id).classList.add('hidden'); }); }
        
        function renderMonths() { 
            const grid = document.getElementById('monthsGrid'); 
            const joursOuverture = getJoursOuverture();
            
            grid.innerHTML = MOIS_NOMS.map((m, i) => { 
                const moisNum = i + 1;
                const jours = joursOuverture[moisNum] || [];
                const isDisabled = jours.length === 0;
                
                if (isDisabled) {
                    return `<div class="month-card disabled"><div class="month-name" style="color:#999;">${m}</div><small style="color:#999;">Ferm√©</small></div>`;
                }
                return `<div class="month-card" onclick="showDays(${i}, '${m}')"><div class="month-name">${m}</div></div>`; 
            }).join(''); 
        }
        
        function showMonths() { hideAll(); document.getElementById('monthsPage').classList.remove('hidden'); }
        
        function showDays(m, name) { 
            curM = m; 
            curMName = name; 
            hideAll(); 
            document.getElementById('daysPage').classList.remove('hidden'); 
            document.getElementById('monthTitle').textContent = name + ' ' + getAnnee(); 
            
            const grid = document.getElementById('daysGrid'); 
            const moisNum = m + 1;
            const jours = getJoursOuverture()[moisNum] || []; 
            const fermeMatin = getFermeMatin()[moisNum] || [];
            const annee = getAnnee();
            
            grid.innerHTML = jours.map(j => { 
                const date = new Date(annee, m, j); 
                const dateFull = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }); 
                const key = `${annee}-${String(moisNum).padStart(2, '0')}-${String(j).padStart(2, '0')}`; 
                const isFermeMatin = fermeMatin.includes(j); 
                const dayRes = reservations[key] || {}; 
                let postesRes = 0; 
                for (let i = 1; i <= 12; i++) { if (i !== 4 && dayRes[i] && dayRes[i].nom) postesRes++; } 
                const postesLibres = 11 - postesRes; 
                return `<div class="day-card" onclick="showPostes(${j}, '${key}', '${dateFull}')"><div style="color: ${postesLibres === 0 ? '#dc3545' : '#28a745'}; font-size: 0.85em;">${postesLibres === 0 ? 'COMPLET' : postesLibres + ' libre(s)'}</div><div class="day-number">${dateFull}</div>${isFermeMatin ? '<div class="closed-morning">‚ö†Ô∏è FERM√â LE MATIN</div>' : ''}</div>`; 
            }).join(''); 
        }
        
        function showPostes(j, key, dateFull) { curDKey = key; curFullDate = dateFull; hideAll(); document.getElementById('postesPage').classList.remove('hidden'); document.getElementById('postePageTitle').textContent = dateFull + " " + getAnnee(); renderPostes(); }
        function backToDays() { showDays(curM, curMName); }
        
        function renderPostes() { const grid = document.getElementById('postesGrid'); grid.innerHTML = ''; if (!reservations[curDKey]) reservations[curDKey] = {}; let libres = 0, reserves = 0, controles = 0; for (let i = 1; i <= 12; i++) { const data = reservations[curDKey][i] || { nom: '', prenom: '', controlled: false }; if (i !== 4) { if (data.nom) { reserves++; if (data.controlled) controles++; } else { libres++; } } grid.appendChild(createBox(i, data)); } document.getElementById('statLibre').textContent = libres; document.getElementById('statReserve').textContent = reserves; document.getElementById('statControle').textContent = controles; }
        
        function createBox(n, data) { const div = document.createElement('div'); const isControleur = n === 4; const hasName = data.nom && data.nom.trim() !== ''; let className = 'poste-box '; if (isControleur) className += 'controleur'; else if (data.controlled) className += 'controle'; else if (hasName) className += 'reserve'; else className += 'libre'; div.className = className; div.onclick = (e) => { if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') openModal(n, data); }; let html = '<div class="poste-content">'; html += `<div class="poste-title">Poste ${n}</div>`; if (data.controlled && data.heure) html += `<div class="poste-heure">üïí ${data.heure}</div>`; if (hasName) { html += `<div class="poste-nom">${data.nom.toUpperCase()} ${data.prenom}</div>`; if (isUserValid(data.nom, data.prenom)) html += '<div class="badge-peche">ü™™ Carte valide</div>'; html += `<button class="btn-info" onclick="event.stopPropagation(); checkInfo('${escapeHtml(data.nom)}', '${escapeHtml(data.prenom)}')">‚ÑπÔ∏è Info</button>`; } html += '</div>'; if (!isControleur) { if (data.controlled) { html += `<div class="control-zone" onclick="event.stopPropagation(); toggleControle(${n})" style="cursor:pointer;"><span class="control-label checked">‚úÖ Contr√¥l√© par ${data.controleur || 'inconnu'}</span></div>`; } else { html += `<div class="control-zone"><input type="checkbox" id="check_${n}" onclick="event.stopPropagation(); toggleControle(${n})"><label class="control-label">Cliquer pour contr√¥ler</label></div>`; } } div.innerHTML = html; return div; }
        
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML.replace(/'/g, "\\'"); }
        function toggleControle(n) { if (!reservations[curDKey]) reservations[curDKey] = {}; if (!reservations[curDKey][n]) return; pendingControlePoste = n; document.getElementById('selectControleur').value = reservations[curDKey][n].controleur || ''; document.getElementById('controleurModal').style.display = 'block'; }
        function updateControleurSelect() { const select = document.getElementById('selectControleur'); if (!select) return; select.innerHTML = '<option value="">-- Choisir --</option>' + controleurs.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function updateMotifControleurSelect() { const select = document.getElementById('motifControleur'); if (!select) return; select.innerHTML = '<option value="">-- Choisir le contr√¥leur --</option>' + controleurs.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function closeControleurModal() { document.getElementById('controleurModal').style.display = 'none'; pendingControlePoste = null; renderPostes(); }
        function confirmControleur() { const controleur = document.getElementById('selectControleur').value; if (!controleur) { alert('Choisir un contr√¥leur'); return; } const poste = reservations[curDKey][pendingControlePoste]; if (poste) { poste.controlled = true; poste.controleur = controleur; const now = new Date(); poste.heure = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0'); saveReservations(); } closeControleurModal(); }
        function annulerControle() { const poste = reservations[curDKey][pendingControlePoste]; if (poste) { poste.controlled = false; poste.controleur = ''; poste.heure = ''; saveReservations(); } closeControleurModal(); }
        
        function openModal(n, data) { curP = n; document.getElementById('modalTitle').textContent = 'Poste ' + n; document.getElementById('modalDate').textContent = curFullDate + " " + getAnnee(); document.getElementById('modalNom').value = data.nom || ''; document.getElementById('modalPrenom').value = data.prenom || ''; document.getElementById('modalControle').checked = data.controlled || false; document.getElementById('modalHeure').value = data.heure || ''; updateControlText(); checkCardBadge(); document.getElementById('checkZone').style.display = n === 4 ? 'none' : 'block'; document.getElementById('infractionsButtons').style.display = (data.nom && n !== 4) ? 'block' : 'none'; document.getElementById('posteModal').style.display = 'block'; }
        function closeModal() { document.getElementById('posteModal').style.display = 'none'; }
        
        function saveModal() { let nom = document.getElementById('modalNom').value.trim().toUpperCase(); let prenom = document.getElementById('modalPrenom').value.trim(); if (!nom || !prenom) { closeModal(); return; } prenom = prenom.charAt(0).toUpperCase() + prenom.slice(1).toLowerCase(); const banni = infractions.bannis ? infractions.bannis.find(b => { if (!b.nom || b.nom.toUpperCase() !== nom || !b.prenom || b.prenom.toLowerCase() !== prenom.toLowerCase()) return false; if (b.typeExclusion === 'temporaire' && b.dateFin) { const now = new Date(); const fin = new Date(b.dateFin); if (now > fin) return false; } return true; }) : null; if (banni) { const typeMsg = banni.typeExclusion === 'temporaire' ? `EXCLU TEMPORAIREMENT jusqu'au ${new Date(banni.dateFin).toLocaleDateString('fr-FR')}` : 'EXCLU D√âFINITIVEMENT'; showAlert(`üö´ ${nom} ${prenom} est ${typeMsg} !`); return; } if (!reservations[curDKey]) reservations[curDKey] = {}; reservations[curDKey][curP] = { nom: nom, prenom: prenom, controlled: document.getElementById('modalControle').checked, heure: document.getElementById('modalHeure').value }; saveReservations(); renderPostes(); closeModal(); }
        function deleteModal() { if (reservations[curDKey] && reservations[curDKey][curP]) { delete reservations[curDKey][curP]; saveReservations(); renderPostes(); } closeModal(); }
        function updateControlText() { const cb = document.getElementById('modalControle'); if (cb.checked) { if (!document.getElementById('modalHeure').value) { const now = new Date(); document.getElementById('modalHeure').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0'); } document.getElementById('controlStatusText').textContent = "‚úÖ Contr√¥l√© √† " + document.getElementById('modalHeure').value; document.getElementById('controlStatusText').style.color = "#17a2b8"; } else { document.getElementById('controlStatusText').textContent = "Cliquer pour valider le contr√¥le"; document.getElementById('controlStatusText').style.color = "#666"; } }
        function isUserValid(nom, prenom) { return validUsers.some(u => u.nom && u.prenom && u.nom.toLowerCase() === nom.trim().toLowerCase() && u.prenom.toLowerCase() === prenom.trim().toLowerCase()); }
        function checkCardBadge() { document.getElementById('modalBadgeZone').style.display = isUserValid(document.getElementById('modalNom').value, document.getElementById('modalPrenom').value) ? 'block' : 'none'; }
        
        function showInfractionsMenu() { hideAll(); document.getElementById('infractionsMenuPage').classList.remove('hidden'); updateCounts(); }
        function updateCounts() { document.getElementById('countAvertissement').textContent = (infractions.avertissements ? infractions.avertissements.length : 0) + ' dossier(s)'; document.getElementById('countBanni').textContent = (infractions.bannis ? infractions.bannis.length : 0) + ' dossier(s)'; }
        
        function showInfractionList(type) { hideAll(); document.getElementById('infractionsDetailPage').classList.remove('hidden'); document.getElementById('detailTitle').textContent = type === 'avertissements' ? '‚ö†Ô∏è AVERTISSEMENTS' : 'üö´ EXCLUSIONS'; const list = infractions[type] || []; const container = document.getElementById('detailList'); if (list.length === 0) { container.innerHTML = '<p style="text-align:center; color:#666;">Aucun dossier</p>'; return; } if (type === 'avertissements') { container.innerHTML = list.map((item, index) => `<div class="infraction-item ${item.archived ? 'archive' : 'avertissement'}"><div class="infraction-header"><div class="infraction-info"><strong>${(item.nom || 'N/A').toUpperCase()} ${item.prenom || ''}</strong>${item.archived ? '<span class="archive-badge">üìÅ Archiv√©</span>' : ''}${item.controleurSanction ? '<span class="controleur-badge">üëÆ ' + item.controleurSanction + '</span>' : ''}<br><small>üìÖ ${item.date || ''}</small><br><small>üìù ${item.motif || ''}</small></div><div class="infraction-actions"><button class="btn btn-delete" onclick="removeAvertissement(${index})">üóëÔ∏è</button></div></div></div>`).join(''); } else { container.innerHTML = list.map((item, index) => { let typeLabel = item.typeExclusion === 'temporaire' ? `<span style="background:#ff9800;color:white;padding:2px 8px;border-radius:4px;font-size:0.8em;">‚è±Ô∏è Temporaire</span>` : `<span style="background:#dc3545;color:white;padding:2px 8px;border-radius:4px;font-size:0.8em;">üö´ D√©finitive</span>`; let finExclusion = ''; if (item.typeExclusion === 'temporaire' && item.dateFin) { const now = new Date(); const fin = new Date(item.dateFin); if (now > fin) { typeLabel = `<span style="background:#28a745;color:white;padding:2px 8px;border-radius:4px;font-size:0.8em;">‚úÖ Expir√©e</span>`; finExclusion = `<br><small style="color:#28a745;">Exclusion termin√©e le ${new Date(item.dateFin).toLocaleDateString('fr-FR')}</small>`; } else { finExclusion = `<br><small style="color:#ff9800;">Fin de l'exclusion : ${new Date(item.dateFin).toLocaleDateString('fr-FR')}</small>`; } } let motifsHtml = ''; if (item.motifs && item.motifs.length > 0) { motifsHtml = `<div class="motifs-list"><h4>üìã Historique des infractions :</h4>${item.motifs.map((m, i) => `<div class="motif-item"><strong>#${i+1}</strong> - ${m.date || ''}: ${m.motif || ''}${m.controleurSanction ? ' <em>(üëÆ ' + m.controleurSanction + ')</em>' : ''}</div>`).join('')}</div>`; } else if (item.motif) { motifsHtml = `<div class="motifs-list"><h4>üìã Motif :</h4><div class="motif-item">${item.motif}</div></div>`; } return `<div class="infraction-item banni"><div class="infraction-header"><div class="infraction-info"><strong>${(item.nom || 'N/A').toUpperCase()} ${item.prenom || ''}</strong> ${typeLabel}${item.controleurSanction ? '<span class="controleur-badge">üëÆ ' + item.controleurSanction + '</span>' : ''}<br><small>üìÖ Exclu le : ${item.date || ''}</small>${finExclusion}${motifsHtml}</div><div class="infraction-actions"><button class="btn btn-unban" onclick="leverExclusion(${index})">üîì Lever</button><button class="btn btn-delete" onclick="removeBanni(${index})">üóëÔ∏è</button></div></div></div>`; }).join(''); } }
        
        function removeAvertissement(index) { 
            if (!checkAdminPassword()) return; 
            if (!confirm('Archiver cet avertissement ?')) return;
            const avert = infractions.avertissements[index];
            if (!infractions.archives) infractions.archives = [];
            infractions.archives.push({
                ...avert,
                type: 'avertissement',
                dateArchive: new Date().toLocaleDateString('fr-FR'),
                raisonArchive: 'Archiv√© manuellement'
            });
            infractions.avertissements.splice(index, 1); 
            saveInfractions(); 
            showInfractionList('avertissements'); 
            showAlert("‚úÖ Avertissement archiv√©."); 
        }
        
        function removeBanni(index) { 
            if (!checkAdminPassword()) return; 
            if (!confirm('Supprimer d√©finitivement cette exclusion ? (Pr√©f√©rez "Lever" pour archiver)')) return; 
            infractions.bannis.splice(index, 1); 
            saveInfractions(); 
            showInfractionList('bannis'); 
            showAlert("‚úÖ Exclusion supprim√©e."); 
        }
        
        function leverExclusion(index) { 
            if (!checkAdminPassword()) return; 
            if (!confirm('Lever cette exclusion et l\'archiver ?')) return;
            const b = infractions.bannis[index]; 
            if (!infractions.archives) infractions.archives = [];
            infractions.archives.push({
                ...b,
                type: 'bannissement',
                dateArchive: new Date().toLocaleDateString('fr-FR'),
                raisonArchive: 'Exclusion lev√©e'
            });
            infractions.bannis.splice(index, 1); 
            saveInfractions(); 
            showInfractionList('bannis'); 
            showAlert(`‚úÖ Exclusion lev√©e et archiv√©e pour ${b.nom} ${b.prenom}`); 
        }
        
        function donnerAvertissement() { document.getElementById('motifInput').value = ''; document.getElementById('motifControleur').value = ''; updateMotifControleurSelect(); document.getElementById('motifModal').style.display = 'block'; }
        function closeMotif() { document.getElementById('motifModal').style.display = 'none'; }
        
        // Variable pour stocker les donn√©es de la 2√®me infraction
        let pendingExclusionData = null;
        
        function confirmerAvertissement() { 
            const nom = document.getElementById('modalNom').value.trim().toUpperCase(); 
            const prenom = document.getElementById('modalPrenom').value.trim(); 
            const prenomF = prenom.charAt(0).toUpperCase() + prenom.slice(1).toLowerCase(); 
            const motif = document.getElementById('motifInput').value || "Non sp√©cifi√©"; 
            const controleurSanction = document.getElementById('motifControleur').value || "Non sp√©cifi√©"; 
            const dateNow = new Date().toLocaleString('fr-FR'); 
            if (!infractions.avertissements) infractions.avertissements = []; 
            if (!infractions.bannis) infractions.bannis = []; 
            const fn = (nom + ' ' + prenomF).toLowerCase(); 
            const avertExistants = infractions.avertissements.filter(a => (a.nom + ' ' + a.prenom).toLowerCase() === fn && !a.archived); 
            if (avertExistants.length >= 1) { 
                pendingExclusionData = { motif, controleurSanction };
                closeMotif(); 
                ouvrirChoixExclusion(avertExistants[0]); 
                return; 
            } 
            infractions.avertissements.push({ id: Date.now().toString(), nom, prenom: prenomF, motif, controleurSanction, date: dateNow }); 
            saveInfractions(); 
            closeMotif(); 
            closeModal(); 
            showAlert(`‚ö†Ô∏è <strong>1er AVERTISSEMENT</strong> pour ${nom} ${prenomF}<br><br>üìú Selon le r√®glement :<br>‚Ä¢ Prochain √©cart = <strong>EXCLUSION</strong><br><br>üëÆ Par: ${controleurSanction}`); 
        }
        
        function ouvrirChoixExclusion(avertissementExistant = null) { 
            const nom = document.getElementById('modalNom').value.trim().toUpperCase(); 
            const prenom = document.getElementById('modalPrenom').value.trim(); 
            const prenomF = prenom.charAt(0).toUpperCase() + prenom.slice(1).toLowerCase(); 
            let infoText = ''; 
            
            if (avertissementExistant && pendingExclusionData) { 
                infoText = `<strong>‚ö†Ô∏è 2√®me INFRACTION d√©tect√©e !</strong><br><br>üìú Selon le r√®glement, ${nom} ${prenomF} a d√©j√† re√ßu un avertissement le ${avertissementExistant.date}.<br>Motif pr√©c√©dent : "${avertissementExistant.motif}"<br><br>üìù <strong>Nouvelle infraction :</strong> ${pendingExclusionData.motif}<br>üëÆ <strong>Constat√©e par :</strong> ${pendingExclusionData.controleurSanction}<br><br>üëâ <strong>Choisissez uniquement le type d'exclusion :</strong>`; 
                document.getElementById('exclusionMotifGroup').style.display = 'none';
                document.getElementById('exclusionControleurGroup').style.display = 'none';
            } else { 
                pendingExclusionData = null;
                infoText = `<strong>üö´ Exclusion directe</strong><br><br>Vous allez exclure ${nom} ${prenomF}.<br>Remplissez les informations ci-dessous.`; 
                document.getElementById('exclusionMotifGroup').style.display = 'block';
                document.getElementById('exclusionControleurGroup').style.display = 'block';
                document.getElementById('exclusionMotif').value = '';
                document.getElementById('exclusionControleur').value = '';
            } 
            
            document.getElementById('exclusionInfo').innerHTML = infoText; 
            document.querySelectorAll('input[name="typeExclusion"]').forEach(r => r.checked = false); 
            document.querySelectorAll('#exclusionModal label[style*=flex]').forEach(l => l.style.borderColor = '#ddd'); 
            updateExclusionControleurSelect(); 
            document.getElementById('exclusionModal').style.display = 'block'; 
        }
        function closeExclusion() { document.getElementById('exclusionModal').style.display = 'none'; }
        function updateExclusionControleurSelect() { const s = document.getElementById('exclusionControleur'); s.innerHTML = '<option value="">-- Choisir le contr√¥leur --</option>'; (controleurs || []).forEach(c => { if (c) s.innerHTML += `<option value="${c}">${c}</option>`; }); }
        
        function confirmerExclusion() { 
            const nom = document.getElementById('modalNom').value.trim().toUpperCase(); 
            const prenom = document.getElementById('modalPrenom').value.trim(); 
            const prenomF = prenom.charAt(0).toUpperCase() + prenom.slice(1).toLowerCase(); 
            
            let motif, controleurSanction;
            if (pendingExclusionData) {
                motif = pendingExclusionData.motif;
                controleurSanction = pendingExclusionData.controleurSanction;
            } else {
                motif = document.getElementById('exclusionMotif').value || "Non sp√©cifi√©"; 
                controleurSanction = document.getElementById('exclusionControleur').value || "Non sp√©cifi√©";
            }
            
            const typeExclusion = document.querySelector('input[name="typeExclusion"]:checked')?.value; 
            if (!typeExclusion) { alert('Veuillez choisir le type d\'exclusion (temporaire ou d√©finitive)'); return; } 
            
            const dateNow = new Date().toLocaleString('fr-FR'); 
            const fn = (nom + ' ' + prenomF).toLowerCase(); 
            const avertExistants = (infractions.avertissements || []).filter(a => (a.nom + ' ' + a.prenom).toLowerCase() === fn && !a.archived); 
            let motifs = avertExistants.map(a => ({ motif: a.motif, date: a.date, controleurSanction: a.controleurSanction })); 
            motifs.push({ motif, date: dateNow, controleurSanction }); 
            
            let dateFin = null; 
            if (typeExclusion === 'temporaire') { 
                dateFin = new Date(); 
                dateFin.setMonth(dateFin.getMonth() + 1); 
                dateFin = dateFin.toISOString(); 
            } 
            
            // Archiver les avertissements
            avertExistants.forEach(a => {
                if (!infractions.archives) infractions.archives = [];
                infractions.archives.push({
                    ...a,
                    type: 'avertissement',
                    dateArchive: new Date().toLocaleDateString('fr-FR'),
                    raisonArchive: 'Converti en exclusion'
                });
            });
            
            infractions.bannis.push({ id: Date.now().toString(), nom, prenom: prenomF, motifs, motif, controleurSanction, date: dateNow, typeExclusion, dateFin }); 
            infractions.avertissements = (infractions.avertissements || []).filter(a => (a.nom + ' ' + a.prenom).toLowerCase() !== fn || a.archived); 
            saveInfractions(); 
            
            pendingExclusionData = null;
            closeExclusion(); 
            closeModal(); 
            const typeText = typeExclusion === 'temporaire' ? 'TEMPORAIRE (1 mois)' : 'D√âFINITIVE'; 
            const finText = typeExclusion === 'temporaire' ? `<br>üìÖ Fin de l'exclusion : ${new Date(dateFin).toLocaleDateString('fr-FR')}` : ''; 
            showAlert(`üö´ <strong>EXCLUSION ${typeText}</strong><br><br>${nom} ${prenomF} est maintenant exclu(e).${finText}<br><br>üëÆ Par: ${controleurSanction}`); 
        }
        
        function checkInfo(nom, prenom) { 
            const fullName = (nom + ' ' + prenom).toLowerCase(); 
            const avertissements = infractions.avertissements ? infractions.avertissements.filter(a => (a.nom + ' ' + a.prenom).toLowerCase() === fullName && !a.archived) : []; 
            const bannissement = infractions.bannis ? infractions.bannis.find(b => (b.nom + ' ' + b.prenom).toLowerCase() === fullName) : null; 
            const isValid = isUserValid(nom, prenom); 
            let html = `<div style="text-align: left;"><h3 style="text-align: center;">${nom.toUpperCase()} ${prenom}</h3>`; 
            html += `<p>${isValid ? 'ü™™ Carte valide' : '‚ùå Pas de carte'}</p>`; 
            if (bannissement) { 
                let isExpired = false;
                if (bannissement.typeExclusion === 'temporaire' && bannissement.dateFin) {
                    const now = new Date();
                    const fin = new Date(bannissement.dateFin);
                    isExpired = now > fin;
                }
                if (isExpired) {
                    html += '<p style="color:#28a745;font-weight:bold;">‚úÖ Exclusion temporaire EXPIR√âE</p>';
                    html += `<p><small>L'exclusion s'est termin√©e le ${new Date(bannissement.dateFin).toLocaleDateString('fr-FR')}</small></p>`;
                } else {
                    const typeText = bannissement.typeExclusion === 'temporaire' ? '‚è±Ô∏è EXCLU TEMPORAIREMENT' : 'üö´ EXCLU D√âFINITIVEMENT';
                    html += `<p style="color:#dc3545;font-weight:bold;">${typeText}</p>`;
                    if (bannissement.typeExclusion === 'temporaire' && bannissement.dateFin) {
                        html += `<p style="color:#ff9800;">üìÖ Fin de l'exclusion : ${new Date(bannissement.dateFin).toLocaleDateString('fr-FR')}</p>`;
                    }
                    if (bannissement.controleurSanction) html += `<p>üëÆ Sanctionn√© par: <strong>${bannissement.controleurSanction}</strong></p>`;
                }
                if (bannissement.motifs && bannissement.motifs.length > 0) { 
                    html += '<div class="info-motifs" style="background: #f8d7da;"><h4 style="color: #721c24;">Historique des infractions :</h4>'; 
                    bannissement.motifs.forEach((m, i) => { html += `<div class="info-motif-item"><strong>#${i+1}</strong> - ${m.date || ''}: ${m.motif || ''}${m.controleurSanction ? '<br>üëÆ ' + m.controleurSanction : ''}</div>`; }); 
                    html += '</div>'; 
                } 
            } else { 
                html += '<p style="color: #28a745;">‚úÖ Non exclu</p>'; 
            } 
            if (avertissements.length > 0) { 
                html += `<p style="font-weight:bold;color:#ffc107;">‚ö†Ô∏è AVERTISSEMENT EN COURS</p>`;
                html += `<p style="color:#dc3545;"><strong>üìú Prochain √©cart = EXCLUSION</strong></p>`;
                html += '<div class="info-motifs" style="background:#fff3cd;"><h4>D√©tail de l\'avertissement :</h4>'; 
                avertissements.forEach((a, i) => { html += `<div class="info-motif-item">${a.date || ''}: ${a.motif || ''}${a.controleurSanction ? '<br>üëÆ ' + a.controleurSanction : ''}</div>`; }); 
                html += '</div>'; 
            } else if (!bannissement) {
                html += '<p style="color:#28a745;">‚úÖ Aucun avertissement</p>';
            }
            html += '</div>'; 
            showAlert(html); 
        }
        
        function openAdmin() { if (prompt("Code Admin :") === "admin") { renderAdminList(); document.getElementById('adminModal').style.display = 'block'; } }
        function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }
        function addValidUser() { let nom = document.getElementById('adminAddNom').value.trim().toUpperCase(); let prenom = document.getElementById('adminAddPrenom').value.trim(); if (nom && prenom) { prenom = prenom.charAt(0).toUpperCase() + prenom.slice(1).toLowerCase(); validUsers.push({ nom: nom, prenom: prenom }); saveValidUsers(); renderAdminList(); document.getElementById('adminAddNom').value = ""; document.getElementById('adminAddPrenom').value = ""; } }
        function renderAdminList() { const container = document.getElementById('adminValidList'); container.innerHTML = validUsers.length === 0 ? '<p style="color:#666; text-align:center;">Aucun p√™cheur</p>' : validUsers.map((u, i) => `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; background:#f8f9fa; padding:8px 12px; border-radius:5px;"><span>${u.nom} ${u.prenom}</span><button onclick="removeValidUser(${i})" style="color:red; border:none; background:none; cursor:pointer;">‚úñ</button></div>`).join(''); }
        function removeValidUser(index) { if (confirm('Supprimer ?')) { validUsers.splice(index, 1); saveValidUsers(); renderAdminList(); } }
        function showAlert(msg) { document.getElementById('alertBody').innerHTML = msg; document.getElementById('alertModal').style.display = 'block'; }
        function closeAlert() { document.getElementById('alertModal').style.display = 'none'; }
        
        document.addEventListener('DOMContentLoaded', function() { if (firebaseReady) { document.getElementById('firebaseStatus').innerHTML = '‚úÖ Firebase connect√©'; document.getElementById('firebaseStatus').style.color = 'green'; } if (sessionStorage.getItem('logged') === 'true') { const checkFb = setInterval(() => { if (firebaseReady) { clearInterval(checkFb); document.getElementById('loginPage').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; document.body.className = 'app-mode'; setupFirebaseListeners(); renderMonths(); updateCounts(); } }, 100); } });
    </script>
</body>
</html>
