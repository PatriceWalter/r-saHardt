<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation Postes Hardt 2026 - Firebase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .breadcrumb { background: #f8f9fa; padding: 15px 30px; display: flex; align-items: center; gap: 10px; font-size: 0.95em; color: #6c757d; }
        .breadcrumb a { color: #667eea; text-decoration: none; cursor: pointer; }
        .content { padding: 30px; }
        .months-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .month-card { background: white; border: 3px solid #e9ecef; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .month-card:hover { border-color: #667eea; transform: translateY(-5px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3); }
        .month-card .month-name { font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .day-card { background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .day-stats { font-size: 0.85em; color: #28a745; margin-top: 10px; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .postes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .poste-box { background: #f8f9fa; border: 3px solid #dee2e6; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative; }
        .poste-checkbox { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; }
        .poste-box.libre { border-color: #28a745; background: #e8f5e9; }
        .poste-box.reserve { border-color: #ffc107; background: #fff9e6; }
        .poste-box.controle { border-color: #17a2b8; background: #e7f6f8; }
        .poste-box.controleur { border-color: #ffd700; border-width: 4px; background: #fffbf0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 20px; padding: 0 30px; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; }
        .modal-actions { display: flex; gap: 10px; padding: 20px 30px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; }
        .btn-save { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .hidden { display: none; }
        /* Style Alertes */
        .alert-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .alert-content { background: white; margin: 15% auto; width: 90%; max-width: 400px; border-radius: 15px; text-align: center; }
        .alert-header { padding: 20px; color: white; border-radius: 15px 15px 0 0; }
        .alert-header.error { background: #dc3545; }
        .alert-header.warning { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã R√©servation Postes Hardt 2026</h1>
            <p id="headerSubtitle">S√©lectionnez un mois</p>
        </div>

        <div class="breadcrumb" id="breadcrumb">
            <a onclick="showMonths()">Accueil</a>
        </div>

        <div id="monthsPage" class="content">
            <div class="months-grid" id="monthsGrid"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="showInfractions()" style="background: #e53e3e; color: white; max-width: 300px;">‚ö†Ô∏è Listing Infractions</button>
            </div>
        </div>

        <div id="infractionsPage" class="content hidden">
            <button class="btn" onclick="showMonths()" style="background: #6c757d; color: white; margin-bottom: 20px;">‚Üê Retour</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="border: 2px solid orange; padding: 15px; border-radius: 10px;">
                    <h3>‚ö†Ô∏è Avertissements</h3>
                    <div id="avertissementsList"></div>
                </div>
                <div style="border: 2px solid red; padding: 15px; border-radius: 10px;">
                    <h3>üö´ Bannis</h3>
                    <div id="bannisList"></div>
                </div>
            </div>
        </div>

        <div id="daysPage" class="content hidden">
            <button class="btn" onclick="showMonths()" style="background: #6c757d; color: white; margin-bottom: 20px;">‚Üê Retour aux mois</button>
            <h2 id="monthTitle" style="text-align: center; margin-bottom: 20px;"></h2>
            <div id="daysGrid" class="days-grid"></div>
        </div>

        <div id="postesPage" class="content hidden">
            <button class="btn" onclick="backToDays()" style="background: #6c757d; color: white; margin-bottom: 20px;">‚Üê Retour aux jours</button>
            <div class="stats-bar">
                <div class="stat-box"><div id="statLibre" style="font-size: 2em; font-weight: bold;">0</div><div>Libres</div></div>
                <div class="stat-box"><div id="statReserve" style="font-size: 2em; font-weight: bold;">0</div><div>R√©serv√©s</div></div>
                <div class="stat-box"><div id="statControle" style="font-size: 2em; font-weight: bold;">0</div><div>Contr√¥l√©s</div></div>
            </div>
            <div id="postesGrid" class="postes-grid"></div>
        </div>
    </div>

    <div id="posteModal" class="modal">
        <div class="modal-content">
            <div class="header"><h2 id="modalTitle"></h2><p id="modalDate"></p></div>
            <div class="form-group"><br><label>Nom</label><input type="text" id="modalNom"></div>
            <div class="form-group"><label>Pr√©nom</label><input type="text" id="modalPrenom"></div>
            <div class="form-group" id="ctrlGroup">
                <input type="checkbox" id="modalControle" style="width: 20px; height: 20px;"> <label>Marquer comme contr√¥l√©</label>
            </div>
            <div id="infractionsButtons" style="padding: 10px 30px; display: none; text-align: center;">
                <button class="btn" onclick="addInfraction('avertissements')" style="background: #ffc107;">‚ö†Ô∏è Avertissement</button>
                <button class="btn" onclick="addInfraction('bannis')" style="background: #dc3545; color: white;">üö´ Bannir</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-save" onclick="saveModal()">üíæ Sauver</button>
                <button class="btn btn-delete" onclick="deleteModal()">üóëÔ∏è Effacer</button>
                <button class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">Fermer</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="alert-modal">
        <div class="alert-content">
            <div id="alertHeader" class="alert-header"></div>
            <p id="alertBody" style="padding: 20px;"></p>
            <button class="btn" onclick="closeAlert()" style="margin-bottom: 10px;">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADXcfDOBLHC7pdlGedDW-4wAHKyPHW19I",
            authDomain: "resahardt.firebaseapp.com",
            projectId: "resahardt",
            storageBucket: "resahardt.firebasestorage.app",
            messagingSenderId: "159584744908",
            appId: "1:159584744908:web:1cc909277052b56e945969",
            measurementId: "G-ZCGBGZK2P9"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CONFIG & √âTAT ---
        const NUM_POSTES = 12;
        const MOIS_NOMS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const JOURS_OUVERTURE = {
            1: [28], 2: [6, 7, 13, 14, 20, 21, 22, 27, 28], 3: [3, 4, 5, 10, 11, 17, 18, 24, 25],
            4: Array.from({length: 27}, (_, i) => i + 5), 5: Array.from({length: 30}, (_, i) => i + 1),
            6: Array.from({length: 31}, (_, i) => i + 1), 7: Array.from({length: 31}, (_, i) => i + 1),
            8: Array.from({length: 30}, (_, i) => i + 1), 9: [2, 3, 9, 10, 16, 17, 23, 24, 30, 31],
            10: [6, 7, 10, 13, 14, 20, 21, 27, 28], 11: [4, 5, 11, 12, 18, 19, 24, 25, 26]
        };

        let reservations = {};
        let infractions = { avertissements: [], bannis: [] };
        let currentMonth = 0, currentDay = 0, currentDateKey = '', currentPosteNum = 0;

        // --- √âCOUTE TEMPS R√âEL FIREBASE ---
        onValue(ref(db, 'reservations'), (snapshot) => {
            reservations = snapshot.val() || {};
            if (currentDateKey) renderPostes(currentDateKey);
            if (!document.getElementById('daysPage').classList.contains('hidden')) renderDays(currentMonth);
        });

        onValue(ref(db, 'infractions'), (snapshot) => {
            const data = snapshot.val() || { avertissements: {}, bannis: {} };
            infractions.avertissements = Object.values(data.avertissements || {});
            infractions.bannis = Object.values(data.bannis || {});
            renderInfractionsList();
        });

        // --- NAVIGATION ---
        window.showMonths = function() {
            const grid = document.getElementById('monthsGrid');
            grid.innerHTML = '';
            MOIS_NOMS.forEach((nom, i) => {
                if (i === 0) return;
                const card = document.createElement('div');
                card.className = 'month-card';
                card.innerHTML = `<div class="month-name">${nom}</div><div class="month-info">2026</div>`;
                card.onclick = () => showDays(i, nom);
                grid.appendChild(card);
            });
            document.getElementById('monthsPage').classList.remove('hidden');
            document.getElementById('daysPage').classList.add('hidden');
            document.getElementById('postesPage').classList.add('hidden');
            document.getElementById('infractionsPage').classList.add('hidden');
            document.getElementById('breadcrumb').innerHTML = '<a onclick="showMonths()">Accueil</a>';
        };

        window.showDays = function(m, nom) {
            currentMonth = m;
            document.getElementById('monthTitle').textContent = nom + " 2026";
            renderDays(m);
            document.getElementById('monthsPage').classList.add('hidden');
            document.getElementById('daysPage').classList.remove('hidden');
            document.getElementById('breadcrumb').innerHTML = `<a onclick="showMonths()">Accueil</a> > ${nom}`;
        };

        function renderDays(m) {
            const grid = document.getElementById('daysGrid');
            grid.innerHTML = '';
            (JOURS_OUVERTURE[m] || []).forEach(j => {
                const dKey = `2026-${String(m + 1).padStart(2, '0')}-${String(j).padStart(2, '0')}`;
                const res = reservations[dKey] || {};
                let count = 0;
                Object.keys(res).forEach(k => { if(k != "4" && res[k].nom) count++; });
                
                const card = document.createElement('div');
                card.className = 'day-card';
                card.innerHTML = `<div style="font-size:1.5em; font-weight:bold;">${j}</div><div style="color:green">${11-count} libres</div>`;
                card.onclick = () => showPostes(m, j, dKey);
                grid.appendChild(card);
            });
        }

        window.showPostes = function(m, j, dKey) {
            currentDateKey = dKey;
            currentDay = j;
            document.getElementById('daysPage').classList.add('hidden');
            document.getElementById('postesPage').classList.remove('hidden');
            renderPostes(dKey);
        };

        window.backToDays = () => {
            currentDateKey = '';
            document.getElementById('postesPage').classList.add('hidden');
            document.getElementById('daysPage').classList.remove('hidden');
        };

        function renderPostes(dKey) {
            const grid = document.getElementById('postesGrid');
            grid.innerHTML = '';
            const dayData = reservations[dKey] || {};
            
            let l = 0, r = 0, c = 0;

            for (let i = 1; i <= NUM_POSTES; i++) {
                const data = dayData[i] || { nom: '', prenom: '', controlled: false };
                if (i === 4 && !data.nom) data.nom = "CONTR√îLEUR";

                const isR = data.nom && data.nom.trim() !== "";
                const isC = data.controlled;
                
                if (i !== 4) {
                    if (isC) c++; else if (isR) r++; else l++;
                }

                const box = document.createElement('div');
                box.className = `poste-box ${i===4?'controleur':isC?'controle':isR?'reserve':'libre'}`;
                box.innerHTML = `
                    ${i!==4?`<input type="checkbox" class="poste-checkbox" ${isC?'checked':''} onclick="event.stopPropagation(); toggleCtrl(${i})">`:''}
                    <div style="font-weight:bold">Poste ${i}</div>
                    <div>${data.nom} ${data.prenom || ''}</div>
                `;
                box.onclick = () => openModal(i, data);
                grid.appendChild(box);
            }
            document.getElementById('statLibre').textContent = l;
            document.getElementById('statReserve').textContent = r;
            document.getElementById('statControle').textContent = c;
        }

        // --- ACTIONS ---
        window.openModal = (num, data) => {
            currentPosteNum = num;
            document.getElementById('modalTitle').textContent = "Poste " + num;
            document.getElementById('modalNom').value = data.nom || '';
            document.getElementById('modalPrenom').value = data.prenom || '';
            document.getElementById('modalControle').checked = data.controlled || false;
            document.getElementById('ctrlGroup').style.display = (num === 4) ? 'none' : 'block';
            document.getElementById('infractionsButtons').style.display = (data.nom) ? 'block' : 'none';
            document.getElementById('posteModal').style.display = 'block';
        };

        window.closeModal = () => document.getElementById('posteModal').style.display = 'none';

        window.saveModal = async () => {
            const n = document.getElementById('modalNom').value.trim();
            const p = document.getElementById('modalPrenom').value.trim();
            const c = document.getElementById('modalControle').checked;

            if (n && p) {
                const full = (n + " " + p).toLowerCase();
                if (infractions.bannis.some(b => (b.nom + " " + b.prenom).toLowerCase() === full)) {
                    return showAlert("üö´ Cette personne est BANNIE !", "error");
                }
                if (infractions.avertissements.some(a => (a.nom + " " + a.prenom).toLowerCase() === full)) {
                    showAlert("‚ö†Ô∏è Attention : Avertissement en cours", "warning");
                }
            }

            await set(ref(db, `reservations/${currentDateKey}/${currentPosteNum}`), {
                nom: n, prenom: p, controlled: (currentPosteNum === 4 ? false : c)
            });
            closeModal();
        };

        window.deleteModal = async () => {
            await remove(ref(db, `reservations/${currentDateKey}/${currentPosteNum}`));
            closeModal();
        };

        window.toggleCtrl = async (num) => {
            const current = (reservations[currentDateKey] && reservations[currentDateKey][num]) ? reservations[currentDateKey][num].controlled : false;
            await update(ref(db, `reservations/${currentDateKey}/${num}`), { controlled: !current });
        };

        // --- INFRACTIONS ---
        window.showInfractions = () => {
            document.getElementById('monthsPage').classList.add('hidden');
            document.getElementById('infractionsPage').classList.remove('hidden');
        };

        window.addInfraction = async (type) => {
            const n = document.getElementById('modalNom').value;
            const p = document.getElementById('modalPrenom').value;
            const id = Date.now();
            await set(ref(db, `infractions/${type}/${id}`), { id, nom: n, prenom: p, date: new Date().toLocaleDateString() });
            closeModal();
            showAlert("Infraction ajout√©e", "warning");
        };

        function renderInfractionsList() {
            const listA = document.getElementById('avertissementsList');
            const listB = document.getElementById('bannisList');
            listA.innerHTML = infractions.avertissements.map(i => `<div>${i.nom} ${i.prenom} <button onclick="removeInfra('avertissements','${i.id}')">X</button></div>`).join('');
            listB.innerHTML = infractions.bannis.map(i => `<div>${i.nom} ${i.prenom} <button onclick="removeInfra('bannis','${i.id}')">X</button></div>`).join('');
        }

        window.removeInfra = async (type, id) => {
            await remove(ref(db, `infractions/${type}/${id}`));
        };

        // --- ALERTES ---
        function showAlert(msg, type) {
            document.getElementById('alertHeader').className = 'alert-header ' + type;
            document.getElementById('alertHeader').textContent = type === 'error' ? 'üö´ BLOQU√â' : '‚ö†Ô∏è ALERTE';
            document.getElementById('alertBody').textContent = msg;
            document.getElementById('alertModal').style.display = 'block';
        }
        window.closeAlert = () => document.getElementById('alertModal').style.display = 'none';

        // Lancement initial
        showMonths();
    </script>
</body>
</html>
