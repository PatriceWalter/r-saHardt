<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Postes Hardt 2026</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        body.login-mode { display: flex; align-items: center; justify-content: center; padding: 20px; }
        body.app-mode { display: block; padding: 20px; }

        #loginPage { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; font-size: 16px; outline: none; }
        .btn-login { width: 100%; background: #667eea; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin-top: 15px; }

        #mainApp { display: none; max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; position: relative; }
        .admin-gear { position: absolute; top: 15px; right: 20px; font-size: 1.5em; cursor: pointer; }
        .breadcrumb { background: #f8f9fa; padding: 15px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .content { padding: 30px; }
        
        .months-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .month-card { background: white; border: 3px solid #e9ecef; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; }
        .month-name { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .day-card { background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; min-height: 110px; display: flex; flex-direction: column; justify-content: center; }
        .closed-morning { color: #dc3545; font-size: 0.85em; font-weight: bold; margin-top: 5px; }
        
        .postes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .poste-box { background: #f8f9fa; border: 3px solid #dee2e6; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative; height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .poste-box.libre { border-color: #28a745; background: #e8f5e9; }
        .poste-box.reserve { border-color: #ffc107; background: #fff9e6; }
        .poste-box.controle { border-color: #17a2b8; background: #e7f6f8; }
        .poste-box.controleur { border-color: #ffd700; border-width: 4px; background: #fffbf0; }
        
        .poste-checkbox { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; cursor: pointer; z-index: 10; }
        .badge-peche { color: #28a745; font-size: 0.75em; font-weight: bold; margin-top: 8px; border: 1.5px solid #28a745; padding: 3px 6px; border-radius: 5px; background: white; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; border-radius: 15px; width: 90%; max-width: 500px; overflow: hidden; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .modal-body { padding: 30px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #dee2e6; border-radius: 8px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #28a745; color: white; width: 100%; margin-bottom: 10px; }
        .btn-delete { background: #dc3545; color: white; width: 100%; }
        .hidden { display: none; }
        .infraction-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body class="login-mode">

    <div id="loginPage">
        <h2>üëÆ Connexion Hardt 2026</h2>
        <input type="password" id="loginPass" class="login-input" placeholder="Mot de passe">
        <button class="btn-login" onclick="checkLogin()">Entrer</button>
    </div>

    <div id="mainApp">
        <div class="header">
            <span class="admin-gear" onclick="openAdmin()">‚öôÔ∏è</span>
            <h1>üìã R√©servations Hardt</h1>
        </div>
        <div class="breadcrumb">
            <a onclick="showMonths()" style="cursor:pointer; font-weight:bold; color:#667eea;">üè† Accueil</a>
            <button onclick="showInfra()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">‚ö†Ô∏è INFRACTIONS</button>
        </div>
        
        <div id="monthsPage" class="content"><div class="months-grid" id="monthsGrid"></div></div>
        <div id="daysPage" class="content hidden">
            <button class="btn" onclick="showMonths()">‚Üê Retour</button>
            <h2 id="monthTitle" style="text-align:center; margin:20px 0;"></h2>
            <div class="days-grid" id="daysGrid"></div>
        </div>
        <div id="postesPage" class="content hidden">
            <button class="btn" onclick="backToDays()">‚Üê Retour</button>
            <h2 id="postePageTitle" style="text-align:center; margin:20px 0;"></h2>
            <div id="postesGrid" class="postes-grid"></div>
        </div>
        <div id="infraPage" class="content hidden">
            <button class="btn" onclick="showMonths()">‚Üê Retour</button>
            <h2 style="text-align:center; margin:20px 0;">Dossiers Infractions</h2>
            <div id="infraList"></div>
        </div>
    </div>

    <div id="posteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle">Poste</h2></div>
            <div class="modal-body">
                <input type="text" id="modalNom" placeholder="NOM" oninput="checkCardBadge()">
                <input type="text" id="modalPrenom" placeholder="Pr√©nom" oninput="checkCardBadge()">
                <div id="modalBadgeZone" style="display:none; margin: 10px 0;"><span class="badge-peche">ü™™ Carte de p√™che valide</span></div>
                <div style="margin: 15px 0;">
                    <input type="checkbox" id="modalControle" style="width:20px; height:20px; vertical-align:middle;"> Contr√¥l√©
                </div>
                <div id="sanctionBtns" style="display:none; margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:8px;">
                    <p style="font-size:0.8em; font-weight:bold; margin-bottom:5px;">Sanctionner :</p>
                    <button onclick="addInfra('Avertissement')" style="background:orange; border:none; color:white; padding:5px; border-radius:4px; cursor:pointer;">‚ö†Ô∏è Avertir</button>
                    <button onclick="addInfra('Banni')" style="background:black; border:none; color:white; padding:5px; border-radius:4px; cursor:pointer;">üö´ Bannir</button>
                </div>
                <button class="btn btn-save" onclick="saveModal()">üíæ Enregistrer</button>
                <button class="btn btn-delete" onclick="deleteModal()">üóëÔ∏è Effacer le poste</button>
                <button class="btn" onclick="closeModal()" style="width:100%; margin-top:10px;">Annuler</button>
            </div>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ü™™ P√™cheurs Valides</h2></div>
            <div class="modal-body">
                <input type="text" id="aNom" placeholder="NOM">
                <input type="text" id="aPre" placeholder="Pr√©nom">
                <button class="btn btn-save" onclick="addV()">Ajouter √† la liste</button>
                <div id="aList" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
                <button class="btn" onclick="document.getElementById('adminModal').style.display='none'" style="width:100%; margin-top:10px;">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyADXcfDOBLHC7pdlGedDW-4wAHKyPHW19I",
            authDomain: "resahardt.firebaseapp.com",
            projectId: "resahardt",
            storageBucket: "resahardt.firebasestorage.app",
            messagingSenderId: "159584744908",
            appId: "1:159584744908:web:1cc909277052b56e945969"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        const JOURS = { 2:[28], 3:[28], 4:[25], 5:[13], 7:[19], 8:[17], 9:[14] };
        const MOIS = ["","","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre"];
        
        let dataStore = {}, valids = [], infras = [];
        let curM, curMName, curK, curP, curFullDate;

        // Synchronisation temps r√©el
        rdb.ref('resas').on('value', s => { dataStore = s.val() || {}; if(curK) renderPostes(); });
        rdb.ref('valids').on('value', s => { valids = Object.values(s.val() || {}); });
        rdb.ref('infras').on('value', s => { infras = s.val() || []; });

        function checkLogin() {
            if(document.getElementById('loginPass').value === "911") {
                document.getElementById('loginPage').style.display='none';
                document.getElementById('mainApp').style.display='block';
                document.body.className='app-mode'; renderMonths();
            }
        }

        function renderMonths() {
            let h = "";
            for(let m in JOURS) h += `<div class="month-card" onclick="showDays(${m}, '${MOIS[m]}')"><div class="month-name">${MOIS[m]}</div></div>`;
            document.getElementById('monthsGrid').innerHTML = h;
        }

        function showDays(m, name) {
            curM = m; curMName = name; hideAll(); document.getElementById('daysPage').classList.remove('hidden');
            document.getElementById('monthTitle').textContent = name + ' 2026';
            document.getElementById('daysGrid').innerHTML = JOURS[m].map(j => {
                const k = `2026-${m}-${j}`;
                return `<div class="day-card" onclick="showPostes('${k}', '${j} ${name}')"><b>${j} ${name}</b><div class="closed-morning">FERM√â LE MATIN</div></div>`;
            }).join('');
        }

        function showPostes(k, t) {
            curK = k; curFullDate = t; hideAll(); document.getElementById('postesPage').classList.remove('hidden');
            document.getElementById('postePageTitle').textContent = t + " 2026"; renderPostes();
        }

        function renderPostes() {
            const g = document.getElementById('postesGrid'); g.innerHTML = '';
            const dayData = dataStore[curK] || {};
            for(let i=1; i<=12; i++) {
                const d = dayData[i] || {nom:'', pre:'', c:false};
                const has = d.nom && d.nom.trim() !== '';
                const isV = isVal(d.nom, d.pre);
                const isB = isBanni(d.nom, d.pre);
                const div = document.createElement('div');
                div.className = `poste-box ${i===4?'controleur':(d.c?'controle':(has?'reserve':'libre'))}`;
                if(isB) div.style.background = "#000";
                div.onclick = () => openModal(i, d);
                
                let h = `${i!==4?`<input type="checkbox" class="poste-checkbox" ${d.c?'checked':''} onclick="event.stopPropagation(); toggleC(${i})">`:''}<div>Poste ${i}</div>`;
                if(has) {
                    h += `<div style="font-weight:bold; ${isB?'color:white':''}">${d.nom.toUpperCase()} ${d.pre}</div>`;
                    if(isV && !isB) h += `<div class="badge-peche">ü™™ Carte de p√™che valide</div>`;
                }
                div.innerHTML = h; g.appendChild(div);
            }
        }

        function isVal(n, p) {
            if(!n || !p) return false;
            return valids.some(u => u.n.toLowerCase() === n.trim().toLowerCase() && u.p.toLowerCase() === p.trim().toLowerCase());
        }

        function isBanni(n, p) {
            if(!n || !p) return false;
            return infras.some(x => x.n.toLowerCase() === n.trim().toLowerCase() && x.p.toLowerCase() === p.trim().toLowerCase() && x.t === 'Banni');
        }

        function openModal(i, d) {
            curP = i; document.getElementById('modalNom').value = d.nom || '';
            document.getElementById('modalPrenom').value = d.pre || '';
            document.getElementById('modalControle').checked = d.c || false;
            document.getElementById('sanctionBtns').style.display = d.nom ? 'block' : 'none';
            checkCardBadge(); document.getElementById('posteModal').style.display = 'block';
        }

        function saveModal() {
            const n = document.getElementById('modalNom').value.trim();
            const p = document.getElementById('modalPrenom').value.trim();
            if(isBanni(n, p)) { alert("Cette personne est BANNIE !"); return; }
            rdb.ref(`resas/${curK}/${curP}`).set({ nom: n, pre: p, c: document.getElementById('modalControle').checked });
            closeModal();
        }

        function toggleC(i) {
            const current = (dataStore[curK] && dataStore[curK][i] && dataStore[curK][i].c) ? true : false;
            rdb.ref(`resas/${curK}/${i}/c`).set(!current);
        }

        function addInfra(type) {
            const n = document.getElementById('modalNom').value;
            const p = document.getElementById('modalPrenom').value;
            const newItem = { n, p, t: type, d: curFullDate };
            infras.push(newItem); rdb.ref('infras').set(infras);
            alert(type + " enregistr√©."); closeModal();
        }

        function showInfra() {
            hideAll(); document.getElementById('infraPage').classList.remove('hidden');
            const l = document.getElementById('infraList'); l.innerHTML = '';
            infras.forEach((x, index) => {
                l.innerHTML += `<div class="infraction-item">
                    <span><b>${x.t}</b>: ${x.n} ${x.p} (${x.d})</span>
                    <button onclick="delInfra(${index})" style="color:red;">Supprimer</button>
                </div>`;
            });
        }

        function delInfra(idx) { infras.splice(idx,1); rdb.ref('infras').set(infras); showInfra(); }
        function openAdmin() { if(prompt("Pass") === "admin") { renderA(); document.getElementById('adminModal').style.display='block'; } }
        function addV() {
            const n = document.getElementById('aNom').value.trim();
            const p = document.getElementById('aPre').value.trim();
            if(n && p) { rdb.ref('valids').push({ n, p }); document.getElementById('aNom').value=''; document.getElementById('aPre').value=''; renderA(); }
        }
        function renderA() {
            const l = document.getElementById('aList'); l.innerHTML = '';
            valids.forEach(u => { l.innerHTML += `<div>- ${u.n} ${u.p}</div>`; });
        }

        function checkCardBadge() {
            const n = document.getElementById('modalNom').value;
            const p = document.getElementById('modalPrenom').value;
            document.getElementById('modalBadgeZone').style.display = isVal(n, p) ? 'block' : 'none';
        }

        function deleteModal() { rdb.ref(`resas/${curK}/${curP}`).remove(); closeModal(); }
        function hideAll() { ['monthsPage','daysPage','postesPage','infraPage'].forEach(id => document.getElementById(id).classList.add('hidden')); }
        function closeModal() { document.getElementById('posteModal').style.display = 'none'; }
        function showMonths() { hideAll(); document.getElementById('monthsPage').classList.remove('hidden'); }
        function backToDays() { showDays(curM, curMName); }
    </script>
</body>
</html>
